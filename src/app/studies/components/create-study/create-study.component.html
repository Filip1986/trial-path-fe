<div class="create-study-container p-4">
  <p-toast />
  <p-confirmDialog />
  <p-card>
    <ng-template #header>
      <div class="card-header px-4 py-3">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Create New Study</h1>
        <p class="text-gray-600">Follow the steps below to create a comprehensive clinical study</p>
      </div>
    </ng-template>

    <div class="wizard-container">
      <!-- Header with Progress -->
      <div class="wizard-header shadow-sm border-round-top p-4 mb-0">
        <div class="flex justify-content-between align-items-center mb-4">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 m-0">Create New Study</h1>
            <p class="text-gray-600 mt-2 mb-0">
              Step {{ currentStep() + 1 }} of {{ formSteps.length }}: {{
              formSteps[currentStep()].label }}
            </p>
          </div>

          <!-- Auto-save indicator -->
          <div class="flex align-items-center gap-3">
            <span *ngIf="autoSaving()" class="text-sm text-blue-600 flex align-items-center gap-2">
              <i class="pi pi-spin pi-spinner"></i>
              Auto-saving...
            </span>
            <span
              *ngIf="studyForm.pristine"
              class="text-sm text-green-600 flex align-items-center gap-2"
            >
              <i class="pi pi-check"></i>
              All changes saved
            </span>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-section mb-4">
          <div class="flex justify-content-between align-items-center mb-2">
            <span class="text-sm font-medium text-gray-700">Overall Progress</span>
            <span class="text-sm text-gray-600">{{ getProgressPercentage() }}% Complete</span>
          </div>
          <p-progressBar [showValue]="false" [value]="getProgressPercentage()" styleClass="h-2rem">
          </p-progressBar>
        </div>
      </div>

      <!-- Form Content with Stepper -->
      <div class="wizard-content shadow-sm p-4">
        <form [formGroup]="studyForm" novalidate>
          <p-stepper [value]="currentStep() + 1" class="basis-[50rem]">
            <p-step-list>
              <p-step [value]="1">Basic Information</p-step>
              <p-step [value]="2">Study Classification</p-step>
              <p-step [value]="3">Timeline</p-step>
              <p-step [value]="4">Study Design</p-step>
              <p-step [value]="5">Population & Sample</p-step>
              <p-step [value]="6">Regulatory & Admin</p-step>
              <p-step [value]="7">Contact Information</p-step>
              <p-step [value]="8">Additional Settings</p-step>
            </p-step-list>
            <p-step-panels>
              <!-- Step 1: Basic Information -->
              <p-step-panel [value]="1">
                <ng-template #content let-activateCallback="activateCallback">
                  <div class="form-step">
                    <div class="step-header mb-4">
                      <h2 class="text-xl font-semibold text-gray-800 flex align-items-center gap-2">
                        <i class="pi pi-info-circle text-blue-500"></i>
                        Basic Information
                      </h2>
                      <p class="text-gray-600 mt-1">Provide essential details about your study</p>
                    </div>

                    <div class="grid grid-cols-12 gap-4">
                      <div class="col-span-12">
                        <lib-input-text
                          [config]="{
                          id: 'title',
                          label: 'Study Title',
                          placeholder: 'Enter the full study title',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Official title of the clinical study (minimum 10 characters)',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autofocus: true
                        }"
                          formControlName="title"
                        >
                        </lib-input-text>
                      </div>

                      <div class="col-span-12 md:col-span-6">
                        <lib-input-text
                          [config]="{
                          id: 'shortTitle',
                          label: 'Short Title',
                          placeholder: 'Enter a short study title',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Abbreviated title for internal use (max 50 characters)',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autofocus: false
                        }"
                          formControlName="shortTitle"
                        >
                        </lib-input-text>
                      </div>

                      <div class="col-span-12">
                        <lib-textarea
                          [config]="{
                          id: 'description',
                          label: 'Study Description',
                          placeholder: 'Provide a detailed description of the study...',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Comprehensive description of the study purpose and design (minimum 50 characters)',
                          rows: 4,
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autoResize: true,
                          maxLength: 2000,
                          autofocus: false
                        }"
                          formControlName="description"
                        >
                        </lib-textarea>
                      </div>

                      <div class="col-span-12">
                        <lib-textarea
                          [config]="{
                          id: 'objectives',
                          label: 'Study Objectives',
                          placeholder: 'Primary and secondary objectives...',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'List the primary and secondary objectives (minimum 20 characters)',
                          rows: 3,
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autoResize: true,
                          maxLength: 1500,
                          autofocus: false
                        }"
                          formControlName="objectives"
                        >
                        </lib-textarea>
                      </div>
                    </div>
                  </div>
                  <div class="flex pt-6 justify-end">
                    <p-button
                      (onClick)="activateCallback(2)"
                      icon="pi pi-arrow-right"
                      iconPos="right"
                      label="Next"
                    />
                  </div>
                </ng-template>
              </p-step-panel>

              <!-- Step 2: Study Classification -->
              <p-step-panel [value]="2">
                <ng-template #content let-activateCallback="activateCallback">
                  <div class="form-step">
                    <div class="step-header mb-4">
                      <h2 class="text-xl font-semibold text-gray-800 flex align-items-center gap-2">
                        <i class="pi pi-tags text-green-500"></i>
                        Study Classification
                      </h2>
                      <p class="text-gray-600 mt-1">Classify and categorize your study</p>
                    </div>

                    <div class="grid grid-cols-12 gap-4">
                      <div class="col-span-12 md:col-span-6">
                        <lib-select
                          [config]="{
                          id: 'studyType',
                          label: 'Study Type',
                          placeholder: 'Select study type',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Type of clinical study being conducted',
                          options: studyTypes,
                          scrollHeight: DEFAULT_SCROLL_HEIGHT,
                          size: FormComponentSizeEnum.NORMAL,
                          disabled: false,
                          labelStyle: FormLabelStyleEnum.DEFAULT
                        }"
                          formControlName="studyType"
                        >
                        </lib-select>
                      </div>

                      <div class="col-span-12 md:col-span-6">
                        <lib-select
                          [config]="{
                          id: 'phase',
                          label: 'Study Phase',
                          placeholder: 'Select study phase',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Clinical trial phase',
                          options: studyPhases,
                          scrollHeight: DEFAULT_SCROLL_HEIGHT,
                          size: FormComponentSizeEnum.NORMAL,
                          disabled: false,
                          labelStyle: FormLabelStyleEnum.DEFAULT
                        }"
                          formControlName="phase"
                        >
                        </lib-select>
                      </div>

                      <div class="col-span-12">
                        <lib-multiselect
                          [config]="{
                          id: 'therapeuticArea',
                          label: 'Therapeutic Areas',
                          placeholder: 'Select therapeutic areas',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'One or more therapeutic areas for this study',
                          options: therapeuticAreas,
                          scrollHeight: DEFAULT_SCROLL_HEIGHT,
                          size: FormComponentSizeEnum.NORMAL,
                          disabled: false,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          showToggleAll: true,
                          filter: true,
                          maxSelectedLabels: 3,
                        }"
                          formControlName="therapeuticArea"
                        >
                        </lib-multiselect>
                      </div>

                      <div class="col-span-12">
                        <lib-input-text
                          [config]="{
                          id: 'indication',
                          label: 'Primary Indication',
                          placeholder: 'Enter the primary indication',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Specify the primary medical condition being studied',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autofocus: false
                        }"
                          formControlName="indication"
                        >
                        </lib-input-text>
                      </div>
                    </div>
                  </div>
                  <div class="flex pt-6 justify-between">
                    <p-button
                      (onClick)="activateCallback(1)"
                      icon="pi pi-arrow-left"
                      label="Back"
                      severity="secondary"
                    />
                    <p-button
                      (onClick)="activateCallback(3)"
                      icon="pi pi-arrow-right"
                      iconPos="right"
                      label="Next"
                    />
                  </div>
                </ng-template>
              </p-step-panel>

              <!-- Step 3: Timeline -->
              <p-step-panel [value]="3">
                <ng-template #content let-activateCallback="activateCallback">
                  <div class="form-step">
                    <div class="step-header mb-4">
                      <h2 class="text-xl font-semibold text-gray-800 flex align-items-center gap-2">
                        <i class="pi pi-calendar text-orange-500"></i>
                        Study Timeline
                      </h2>
                      <p class="text-gray-600 mt-1">Define the study and enrollment timeline</p>
                    </div>

                    <div class="grid grid-cols-12 gap-4">
                      <div class="col-span-12 md:col-span-6">
                        <lib-date-picker
                          [config]="{
                          id: 'plannedStartDate',
                          label: 'Planned Start Date',
                          placeholder: 'Select start date',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'When do you plan to start the study?',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          view: DatePickerViewEnum.DATE,
                          hourFormat: DatePickerHourFormatEnum.TWENTY_FOUR,
                          showIcon: true,
                          showButtonBar: true,
                          iconDisplay: IconDisplayModeEnum.BUTTON,
                          numberOfMonths: 1,
                          showTime: false,
                        }"
                          formControlName="plannedStartDate"
                        >
                        </lib-date-picker>
                      </div>

                      <div class="col-span-12 md:col-span-6">
                        <lib-date-picker
                          [config]="{
                          id: 'plannedEndDate',
                          label: 'Planned End Date',
                          placeholder: 'Select end date',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Expected study completion date',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          view: DatePickerViewEnum.DATE,
                          hourFormat: DatePickerHourFormatEnum.TWENTY_FOUR,
                          showIcon: true,
                          showButtonBar: true,
                          iconDisplay: IconDisplayModeEnum.BUTTON,
                          numberOfMonths: 1,
                          showTime: false,
                        }"
                          formControlName="plannedEndDate"
                        >
                        </lib-date-picker>
                      </div>

                      <div class="col-span-12 md:col-span-6">
                        <lib-date-picker
                          [config]="{
                          id: 'enrollmentStartDate',
                          label: 'Enrollment Start Date',
                          placeholder: 'Select enrollment start',
                          required: false,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'When will participant enrollment begin?',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          view: DatePickerViewEnum.DATE,
                          hourFormat: DatePickerHourFormatEnum.TWENTY_FOUR,
                          showIcon: true,
                          showButtonBar: true,
                          iconDisplay: IconDisplayModeEnum.BUTTON,
                          numberOfMonths: 1,
                          showTime: false,
                        }"
                          formControlName="enrollmentStartDate"
                        >
                        </lib-date-picker>
                      </div>

                      <div class="col-span-12 md:col-span-6">
                        <lib-date-picker
                          [config]="{
                          id: 'enrollmentEndDate',
                          label: 'Enrollment End Date',
                          placeholder: 'Select enrollment end',
                          required: false,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Target enrollment completion date',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          view: DatePickerViewEnum.DATE,
                          hourFormat: DatePickerHourFormatEnum.TWENTY_FOUR,
                          showIcon: true,
                          showButtonBar: true,
                          iconDisplay: IconDisplayModeEnum.BUTTON,
                          numberOfMonths: 1,
                          showTime: false,
                        }"
                          formControlName="enrollmentEndDate"
                        >
                        </lib-date-picker>
                      </div>
                    </div>
                  </div>
                  <div class="flex pt-6 justify-between">
                    <p-button
                      (onClick)="activateCallback(2)"
                      icon="pi pi-arrow-left"
                      label="Back"
                      severity="secondary"
                    />
                    <p-button
                      (onClick)="activateCallback(4)"
                      icon="pi pi-arrow-right"
                      iconPos="right"
                      label="Next"
                    />
                  </div>
                </ng-template>
              </p-step-panel>

              <!-- Step 4: Study Design -->
              <p-step-panel [value]="4">
                <ng-template #content let-activateCallback="activateCallback">
                  <div class="form-step">
                    <div class="step-header mb-4">
                      <h2 class="text-xl font-semibold text-gray-800 flex align-items-center gap-2">
                        <i class="pi pi-cog text-purple-500"></i>
                        Study Design
                      </h2>
                      <p class="text-gray-600 mt-1">
                        Configure the study methodology and design parameters
                      </p>
                    </div>

                    <div class="grid grid-cols-12 gap-4">
                      <div class="col-span-12 md:col-span-6">
                        <lib-select
                          [config]="{
                          id: 'designType',
                          label: 'Design Type',
                          placeholder: 'Select design type',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Overall study design approach',
                          options: designTypes,
                          scrollHeight: DEFAULT_SCROLL_HEIGHT,
                          size: FormComponentSizeEnum.NORMAL,
                          disabled: false,
                          labelStyle: FormLabelStyleEnum.DEFAULT
                        }"
                          formControlName="designType"
                        >
                        </lib-select>
                      </div>

                      <div class="col-span-12 md:col-span-6">
                        <lib-select
                          [config]="{
                          id: 'interventionModel',
                          label: 'Intervention Model',
                          placeholder: 'Select intervention model',
                          required: false,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'How interventions are administered',
                          options: interventionModels,
                          scrollHeight: DEFAULT_SCROLL_HEIGHT,
                          size: FormComponentSizeEnum.NORMAL,
                          disabled: false,
                          labelStyle: FormLabelStyleEnum.DEFAULT
                        }"
                          formControlName="interventionModel"
                        >
                        </lib-select>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-select
                          [config]="{
                          id: 'primaryPurpose',
                          label: 'Primary Purpose',
                          placeholder: 'Select purpose',
                          required: false,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Main objective of the study',
                          options: primaryPurposes,
                          scrollHeight: DEFAULT_SCROLL_HEIGHT,
                          size: FormComponentSizeEnum.NORMAL,
                          disabled: false,
                          labelStyle: FormLabelStyleEnum.DEFAULT
                        }"
                          formControlName="primaryPurpose"
                        >
                        </lib-select>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-select
                          [config]="{
                          id: 'masking',
                          label: 'Masking',
                          placeholder: 'Select masking type',
                          required: false,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Level of blinding in the study',
                          options: maskingTypes,
                          scrollHeight: DEFAULT_SCROLL_HEIGHT,
                          size: FormComponentSizeEnum.NORMAL,
                          disabled: false,
                          labelStyle: FormLabelStyleEnum.DEFAULT
                        }"
                          formControlName="masking"
                        >
                        </lib-select>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-select
                          [config]="{
                          id: 'allocation',
                          label: 'Allocation',
                          placeholder: 'Select allocation method',
                          required: false,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Method of assigning participants',
                          options: allocationTypes,
                          scrollHeight: DEFAULT_SCROLL_HEIGHT,
                          size: FormComponentSizeEnum.NORMAL,
                          disabled: false,
                          labelStyle: FormLabelStyleEnum.DEFAULT
                        }"
                          formControlName="allocation"
                        >
                        </lib-select>
                      </div>
                    </div>
                  </div>
                  <div class="flex pt-6 justify-between">
                    <p-button
                      (onClick)="activateCallback(3)"
                      icon="pi pi-arrow-left"
                      label="Back"
                      severity="secondary"
                    />
                    <p-button
                      (onClick)="activateCallback(5)"
                      icon="pi pi-arrow-right"
                      iconPos="right"
                      label="Next"
                    />
                  </div>
                </ng-template>
              </p-step-panel>

              <!-- Step 5: Population & Sample -->
              <p-step-panel [value]="5">
                <ng-template #content let-activateCallback="activateCallback">
                  <div class="form-step">
                    <div class="step-header mb-4">
                      <h2 class="text-xl font-semibold text-gray-800 flex align-items-center gap-2">
                        <i class="pi pi-users text-indigo-500"></i>
                        Population & Sample Size
                      </h2>
                      <p class="text-gray-600 mt-1">
                        Define the target population and sample characteristics
                      </p>
                    </div>

                    <div class="grid grid-cols-12 gap-4">
                      <div class="col-span-12 md:col-span-4">
                        <lib-input-number
                          [config]="{
                          id: 'plannedEnrollment',
                          label: 'Planned Enrollment',
                          placeholder: 'Enter target enrollment',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Target number of participants',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          min: 1,
                          max: 99999,
                          showButtons: true,
                          buttonLayout: InputNumberButtonLayoutEnum.HORIZONTAL
                        }"
                          formControlName="plannedEnrollment"
                        >
                        </lib-input-number>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-input-number
                          [config]="{
                          id: 'minimumAge',
                          label: 'Minimum Age',
                          placeholder: 'Min age',
                          required: false,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Minimum age in years',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          min: 0,
                          max: 120,
                          showButtons: true,
                          buttonLayout: InputNumberButtonLayoutEnum.HORIZONTAL,
                          suffix: ' years'
                        }"
                          formControlName="minimumAge"
                        >
                        </lib-input-number>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-input-number
                          [config]="{
                          id: 'maximumAge',
                          label: 'Maximum Age',
                          placeholder: 'Max age',
                          required: false,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Maximum age in years',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          min: 0,
                          max: 120,
                          showButtons: true,
                          buttonLayout: InputNumberButtonLayoutEnum.HORIZONTAL,
                          suffix: ' years'
                        }"
                          formControlName="maximumAge"
                        >
                        </lib-input-number>
                      </div>

                      <div class="col-span-12 md:col-span-6">
                        <lib-checkbox
                          [config]="{
                          id: 'healthyVolunteers',
                          label: 'Healthy Volunteers Accepted',
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Can healthy volunteers participate?',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          required: false
                        }"
                          formControlName="healthyVolunteers"
                        >
                        </lib-checkbox>
                      </div>

                      <div class="col-span-12 md:col-span-6">
                        <lib-checkbox
                          [config]="{
                          id: 'genderBased',
                          label: 'Gender-Based Study',
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Is this study focused on a specific gender?',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          required: false
                        }"
                          formControlName="genderBased"
                        >
                        </lib-checkbox>
                      </div>
                    </div>
                  </div>
                  <div class="flex pt-6 justify-between">
                    <p-button
                      (onClick)="activateCallback(4)"
                      icon="pi pi-arrow-left"
                      label="Back"
                      severity="secondary"
                    />
                    <p-button
                      (onClick)="activateCallback(6)"
                      icon="pi pi-arrow-right"
                      iconPos="right"
                      label="Next"
                    />
                  </div>
                </ng-template>
              </p-step-panel>

              <!-- Step 6: Regulatory & Admin -->
              <p-step-panel [value]="6">
                <ng-template #content let-activateCallback="activateCallback">
                  <div class="form-step">
                    <div class="step-header mb-4">
                      <h2 class="text-xl font-semibold text-gray-800 flex align-items-center gap-2">
                        <i class="pi pi-shield text-red-500"></i>
                        Regulatory & Administrative
                      </h2>
                      <p class="text-gray-600 mt-1">
                        Regulatory requirements and administrative details
                      </p>
                    </div>

                    <div class="grid grid-cols-12 gap-4">
                      <div class="col-span-12 md:col-span-6">
                        <lib-input-text
                          [config]="{
                          id: 'sponsorName',
                          label: 'Sponsor Name',
                          placeholder: 'Enter sponsor organization',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Organization responsible for the study',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autofocus: false
                        }"
                          formControlName="sponsorName"
                        >
                        </lib-input-text>
                      </div>

                      <div class="col-span-12 md:col-span-6">
                        <lib-input-text
                          [config]="{
                          id: 'protocolNumber',
                          label: 'Protocol Number',
                          placeholder: 'Enter protocol number',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Unique protocol identifier',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autofocus: false
                        }"
                          formControlName="protocolNumber"
                        >
                        </lib-input-text>
                      </div>

                      <div class="col-span-12">
                        <lib-select
                          [config]="{
                          id: 'principalInvestigatorId',
                          label: 'Principal Investigator',
                          placeholder: 'Select principal investigator',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Lead investigator for this study',
                          options: investigators,
                          scrollHeight: DEFAULT_SCROLL_HEIGHT,
                          size: FormComponentSizeEnum.NORMAL,
                          disabled: false,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          filter: true
                        }"
                          formControlName="principalInvestigatorId"
                        >
                        </lib-select>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-checkbox
                          [config]="{
                          id: 'irbApprovalRequired',
                          label: 'IRB Approval Required',
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Institutional Review Board approval needed',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          required: false
                        }"
                          formControlName="irbApprovalRequired"
                        >
                        </lib-checkbox>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-checkbox
                          [config]="{
                          id: 'fdaIndRequired',
                          label: 'FDA IND Required',
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'FDA Investigational New Drug application required',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          required: false
                        }"
                          formControlName="fdaIndRequired"
                        >
                        </lib-checkbox>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-checkbox
                          [config]="{
                          id: 'gmpRequired',
                          label: 'GMP Compliance Required',
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Good Manufacturing Practice compliance needed',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          required: false
                        }"
                          formControlName="gmpRequired"
                        >
                        </lib-checkbox>
                      </div>
                    </div>
                  </div>
                  <div class="flex pt-6 justify-between">
                    <p-button
                      (onClick)="activateCallback(5)"
                      icon="pi pi-arrow-left"
                      label="Back"
                      severity="secondary"
                    />
                    <p-button
                      (onClick)="activateCallback(7)"
                      icon="pi pi-arrow-right"
                      iconPos="right"
                      label="Next"
                    />
                  </div>
                </ng-template>
              </p-step-panel>

              <!-- Step 7: Contact Information -->
              <p-step-panel [value]="7">
                <ng-template #content let-activateCallback="activateCallback">
                  <div class="form-step">
                    <div class="step-header mb-4">
                      <h2 class="text-xl font-semibold text-gray-800 flex align-items-center gap-2">
                        <i class="pi pi-phone text-teal-500"></i>
                        Contact Information
                      </h2>
                      <p class="text-gray-600 mt-1">Primary contact details for the study</p>
                    </div>

                    <div class="grid grid-cols-12 gap-4">
                      <div class="col-span-12 md:col-span-4">
                        <lib-input-text
                          [config]="{
                          id: 'contactName',
                          label: 'Contact Name',
                          placeholder: 'Enter contact person name',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Primary contact person for study inquiries',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autofocus: false
                        }"
                          formControlName="contactName"
                        >
                        </lib-input-text>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-input-text
                          [config]="{
                          id: 'contactEmail',
                          label: 'Contact Email',
                          placeholder: 'Enter contact email address',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Primary email for study communications',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autofocus: false
                        }"
                          formControlName="contactEmail"
                        >
                        </lib-input-text>
                      </div>

                      <div class="col-span-12 md:col-span-4">
                        <lib-input-text
                          [config]="{
                          id: 'contactPhone',
                          label: 'Contact Phone',
                          placeholder: 'Enter contact phone number',
                          required: true,
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Primary phone number for study inquiries',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          autofocus: false
                        }"
                          formControlName="contactPhone"
                        >
                        </lib-input-text>
                      </div>
                    </div>
                  </div>
                  <div class="flex pt-6 justify-between">
                    <p-button
                      (onClick)="activateCallback(6)"
                      icon="pi pi-arrow-left"
                      label="Back"
                      severity="secondary"
                    />
                    <p-button
                      (onClick)="activateCallback(8)"
                      icon="pi pi-arrow-right"
                      iconPos="right"
                      label="Next"
                    />
                  </div>
                </ng-template>
              </p-step-panel>

              <!-- Step 8: Additional Settings -->
              <p-step-panel [value]="8">
                <ng-template #content let-activateCallback="activateCallback">
                  <div class="form-step">
                    <div class="step-header mb-4">
                      <h2 class="text-xl font-semibold text-gray-800 flex align-items-center gap-2">
                        <i class="pi pi-sliders-h text-gray-500"></i>
                        Additional Settings
                      </h2>
                      <p class="text-gray-600 mt-1">
                        Configure additional study settings and preferences
                      </p>
                    </div>

                    <div class="grid grid-cols-12 gap-4">
                      <div class="col-span-12 md:col-span-3">
                        <lib-checkbox
                          [config]="{
                          id: 'isBlinded',
                          label: 'Blinded Study',
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Is this a blinded/masked study?',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          required: false
                        }"
                          formControlName="isBlinded"
                        >
                        </lib-checkbox>
                      </div>

                      <div class="col-span-12 md:col-span-3">
                        <lib-checkbox
                          [config]="{
                          id: 'allowDataExport',
                          label: 'Allow Data Export',
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Enable data export functionality',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          required: false
                        }"
                          formControlName="allowDataExport"
                        >
                        </lib-checkbox>
                      </div>

                      <div class="col-span-12 md:col-span-3">
                        <lib-checkbox
                          [config]="{
                          id: 'requireElectronicSignature',
                          label: 'Electronic Signatures',
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Require electronic signatures for key documents',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          required: false
                        }"
                          formControlName="requireElectronicSignature"
                        >
                        </lib-checkbox>
                      </div>

                      <div class="col-span-12 md:col-span-3">
                        <lib-checkbox
                          [config]="{
                          id: 'enableAuditTrail',
                          label: 'Enable Audit Trail',
                          variant: FormComponentVariantEnum.OUTLINED,
                          labelPosition: FormLabelPositionEnum.ABOVE,
                          helperText: 'Maintain detailed audit trail of all changes',
                          disabled: false,
                          size: FormComponentSizeEnum.NORMAL,
                          labelStyle: FormLabelStyleEnum.DEFAULT,
                          required: false
                        }"
                          formControlName="enableAuditTrail"
                        >
                        </lib-checkbox>
                      </div>

                      <!-- Summary Section -->
                      <div class="col-span-12 mt-6">
                        <p-divider></p-divider>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Study Summary</h3>
                        <div class="bg-gray-50 border-round p-4">
                          <div class="grid grid-cols-12 gap-4">
                            <div
                              *ngFor="let step of formSteps"
                              class="col-span-12 sm:col-span-6 lg:col-span-3"
                            >
                              <div
                                [ngClass]="step.isCompleted ? 'bg-green-50 text-green-800' : step.isValid ? 'bg-yellow-50 text-yellow-800' : 'bg-red-50 text-red-800'"
                                class="flex align-items-center gap-2 p-2 border-round"
                              >
                                <i
                                  [ngClass]="step.isCompleted ? 'pi-check-circle' : step.isValid ? 'pi-exclamation-triangle' : 'pi-times-circle'"
                                  class="pi"
                                >
                                </i>
                                <span class="text-sm">{{ step.label }}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="flex pt-6 justify-start">
                    <p-button
                      (onClick)="activateCallback(7)"
                      icon="pi pi-arrow-left"
                      label="Back"
                      severity="secondary"
                    />
                  </div>
                </ng-template>
              </p-step-panel>
            </p-step-panels>
          </p-stepper>
        </form>
      </div>

      <!-- Single Footer Navigation (Keep Only This) -->
      <ng-template #footer>
        <div class="wizard-footer border-top-1 surface-border pt-4">
          <div class="flex justify-content-between align-items-center">
            <!-- Previous Button -->
            <p-button
              (onClick)="previousStep()"
              [disabled]="!canProceedToPrevious()"
              [outlined]="true"
              icon="pi pi-chevron-left"
              label="Previous"
              severity="secondary"
            >
            </p-button>

            <!-- Center Actions -->
            <div class="flex gap-2">
              <p-button
                (onClick)="onCancel()"
                [outlined]="true"
                icon="pi pi-times"
                label="Cancel"
                severity="secondary"
              >
              </p-button>

              <p-button
                (onClick)="saveDraft()"
                [loading]="saving()"
                icon="pi pi-save"
                label="Save Draft"
                severity="secondary"
              >
              </p-button>
            </div>

            <!-- Next/Submit Button -->
            <div *ngIf="!isLastStep()">
              <p-button
                (onClick)="nextStep()"
                [disabled]="!canProceedToNext()"
                icon="pi pi-chevron-right"
                iconPos="right"
                label="Next"
                severity="primary"
              >
              </p-button>
            </div>

            <div *ngIf="isLastStep()">
              <p-button
                (onClick)="createStudy()"
                [disabled]="studyForm.invalid"
                [loading]="saving()"
                icon="pi pi-check"
                label="Create Study"
                severity="success"
              >
              </p-button>
            </div>
          </div>

          <!-- Step Indicator -->
          <div class="text-center mt-3">
            <span class="text-sm text-600">
              Step {{ currentStep() + 1 }} of {{ formSteps.length }}
              <ng-container *ngIf="getProgressPercentage() > 0">
                 {{ getProgressPercentage() }}% Complete
              </ng-container>
            </span>
          </div>
        </div>
      </ng-template>
    </div>
  </p-card>
</div>
