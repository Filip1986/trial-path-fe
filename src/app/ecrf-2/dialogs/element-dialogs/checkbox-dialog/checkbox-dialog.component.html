<app-form-dialog-wrapper
  (cancelEvent)="onCancel()"
  (loadPresetEvent)="showLoadPresetDialog()"
  (saveEvent)="onSave()"
  (savePresetEvent)="showSavePresetDialog()"
  (showEvent)="onDialogShow()"
  [header]="dialogConfiguration.title"
  [height]="dialogConfiguration.height"
  [loading]="isSaving"
  [saveDisabled]="!isReadyForSave()"
  [visible]="visible"
  >
  <!-- Preview content -->
  <div previewContent>
    <!-- Display group title if in GROUP mode -->
    @if (form.get('mode')?.value === 'GROUP' && form.get('groupTitle')?.value) {
      <div
        class="mb-2 font-medium"
        >
        {{ form.get('groupTitle')?.value }}
      </div>
    }

    <!-- BINARY Mode -->
    @if (form.get('mode')?.value === 'BINARY' || !form.get('mode')?.value) {
      <div>
        <lib-checkbox
        [config]="{
          label: form.get('label')?.value,
          required: form.get('required')?.value,
          disabled: form.get('disabled')?.value,
          indeterminate: form.get('indeterminate')?.value,
          mode: form.get('mode')?.value,
          size: form.get('size')?.value,
          variant: form.get('variant')?.value,
          helperText: form.get('helperText')?.value,
          labelPosition: form.get('labelPosition')?.value,
          labelStyle: form.get('labelStyle')?.value
        }"
          [disabled]="form.get('disabled')?.value || false"
          [value]="false"
          />
      </div>
    }

    <!-- GROUP Mode -->
    @if (form.get('mode')?.value === 'GROUP') {
      <div class="checkbox-group-preview">
        @if (!hasOptions()) {
          <div class="text-gray-500 italic">
            No checkbox options defined. Add options in the Options tab.
          </div>
        }
        @for (option of getOptions(); track option; let i = $index) {
          <div class="mb-2">
            <lib-checkbox
          [config]="{
            label: option.label,
            required: form.get('required')?.value,
            disabled: option.disabled || form.get('disabled')?.value,
            mode: CheckboxModeEnum.BINARY,
            size: form.get('size')?.value,
            variant: form.get('variant')?.value,
            labelPosition: form.get('labelPosition')?.value,
            labelStyle: form.get('labelStyle')?.value
          }"
              [value]="false"
              />
          </div>
        }
      </div>
    }
  </div>

  <!-- Form content with tabs -->
  <form [formGroup]="form" class="p-fluid" formContent>
    <p-tabs value="0">
      <p-tablist>
        <p-tab value="0">
          Basic Settings
          <app-tab-error-indicator
            [errorCount]="getTabErrorCount(getBasicTabFields())"
            [hasErrors]="hasTabErrors(getBasicTabFields())"
            [warningCount]="getTabWarningCount(getBasicTabFields())"
            />
        </p-tab>
        <p-tab value="1">
          Behavior
          <app-tab-error-indicator
            [errorCount]="getTabErrorCount(getBehaviorTabFields())"
            [hasErrors]="hasTabErrors(getBehaviorTabFields())"
            [warningCount]="getTabWarningCount(getBehaviorTabFields())"
            />
        </p-tab>
        <p-tab value="2">
          Options
          <app-tab-error-indicator
            [errorCount]="getTabErrorCount(getOptionsTabFields())"
            [hasErrors]="hasTabErrors(getOptionsTabFields())"
            [warningCount]="getTabWarningCount(getOptionsTabFields())"
            />
        </p-tab>
        <p-tab value="3">
          Appearance
          <app-tab-error-indicator
            [errorCount]="getTabErrorCount(getAppearanceTabFields())"
            [hasErrors]="hasTabErrors(getAppearanceTabFields())"
            [warningCount]="getTabWarningCount(getAppearanceTabFields())"
            />
        </p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Basic Settings Tab -->
        <p-tabpanel value="0">
          <app-basic-settings [fields]="basicFields" [form]="form">
            <!-- Add groupTitle field if in GROUP mode -->
            @if (form.get('mode')?.value === 'GROUP') {
              <div
                [appFormField]="'groupTitle'"
                [form]="form"
                [suppressErrors]="true"
                colClasses="col-12"
                >
                <lib-input-text
                  [config]="groupTitleConfig"
                  [formControl]="getControl('groupTitle')"
                  />
              </div>
            }
          </app-basic-settings>
        </p-tabpanel>

        <!-- Behavior Tab -->
        <p-tabpanel value="1">
          <app-behavior-settings [form]="form" [options]="behaviorOptions">
            <div class="col-12 mb-4">
              <label class="field-label">Mode</label>
              <p-select
                [formControl]="getControl('mode')"
                [options]="modes"
                [style]="{width: '100%'}"
                appendTo="body"
                optionLabel="label"
                optionValue="value"
                placeholder="Select mode"
                />
            </div>
          </app-behavior-settings>
        </p-tabpanel>

        <!-- Options Tab (for GROUP mode) -->
        <p-tabpanel value="2">
          @if (form.get('mode')?.value === 'GROUP') {
            <div class="col-12">
              <app-options-manager
                (optionsChanged)="onOptionsChanged($event)"
                [controlName]="'options'"
                [minOptions]="1"
                [parentForm]="form"
                />
            </div>
          }
          @if (form.get('mode')?.value !== 'GROUP') {
            <div class="col-12">
              <div class="p-3 bg-gray-100 text-gray-700 rounded">
                <i class="pi pi-info-circle mr-2"></i> Options are only available in GROUP mode.
                Please change the mode to GROUP in the Behavior tab to configure multiple options.
              </div>
            </div>
          }
        </p-tabpanel>

        <!-- Appearance Tab -->
        <p-tabpanel value="3">
          <app-appearance-settings
            [form]="form"
            [labelPositionOptions]="labelPositions"
            [labelStyleOptions]="labelStyles"
            [sizeOptions]="sizes"
            [variantOptions]="variants"
            />
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>

    <!-- Global Form Validation Summary -->
    <app-validation-summary
      [compact]="false"
      [showQualityScore]="true"
      [showWarnings]="true"
      [validationResult]="validationResult"
      />
  </form>
</app-form-dialog-wrapper>

<!-- Save Preset Dialog -->
<app-save-preset-dialog
  (savePreset)="onSavePreset($event)"
  [(visible)]="savePresetDialogVisible"
  [currentConfiguration]="getConfigurationForPreset()"
  [elementType]="dialogConfiguration.elementType"
  />

<!-- Load Preset Dialog -->
<app-load-preset-dialog
  (loadPreset)="onLoadPreset($event)"
  (presetDeleted)="onPresetDeleted($event)"
  [(visible)]="loadPresetDialogVisible"
  [elementType]="dialogConfiguration.elementType"
  />

<p-confirmDialog
  [baseZIndex]="10000"
  [style]="{width: '450px'}"
  acceptButtonStyleClass="p-button-danger"
  rejectButtonStyleClass="p-button-secondary"
  />
