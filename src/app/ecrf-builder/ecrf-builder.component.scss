// Base variables and mixins
$element-transition: all 0.2s ease;
$primary-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
$hover-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
$preview-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);

// Common reusable mixins
@mixin card-style {
  border: 1px solid var(--surface-border);
  border-radius: 4px;
  background-color: var(--surface-card);
}

// Animations
@keyframes point-left {
  0%, 100% { transform: translateX(0); }
  50% { transform: translateX(-5px); }
}

@keyframes scale-in {
  from { transform: scale(0.8); opacity: 0.5; }
  to { transform: scale(1); opacity: 0.8; }
}

@keyframes pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 0.3; }
}

@keyframes return-to-position {
  0% { transform: translate(10px, 10px); }
  100% { transform: translate(0, 0); }
}

@keyframes highlight-drop-zone {
  0% { box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.3); }
  50% { box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb), 0.5); }
  100% { box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.3); }
}

.cdk-drag-preview {
  box-sizing: border-box;
  border-radius: 4px;
  box-shadow: 0 5px 5px -3px rgba(0, 0, 0, 0.2),
  0 8px 10px 1px rgba(0, 0, 0, 0.14),
  0 3px 14px 2px rgba(0, 0, 0, 0.12);
}

.cdk-drop-list-dragging {
  background-color: var(--surface-hover);
  border-color: var(--primary-color);
}

.cdk-drop-list-receiving {
  border-color: var(--primary-color);
  background-color: rgba(var(--primary-color-rgb), 0.05);
  animation: highlight-drop-zone 1.5s infinite;
}

.cdk-drag-preview {
  opacity: 0.8;
}

.cdk-drag-placeholder {
  opacity: 0;
}

.cdk-drag-animating {
  transition: transform 300ms cubic-bezier(0.2, 1, 0.1, 1);
}

// CDK Drag Drop animations
.cdk-drop-list-dragging .form-element-wrapper:not(.cdk-drag-placeholder) {
  transition: transform 250ms cubic-bezier(0, 0, 0.2, 1);
}

.cdk-drag-animating {
  transition: transform 300ms cubic-bezier(0.2, 1, 0.1, 1) !important;
}

// Invalid drop targets
.cdk-drop-list-invalid {
  background-color: rgba(255, 0, 0, 0.05) !important;
  border-color: var(--red-300) !important;
}

// Released but not dropped
.cdk-drag-released:not(.cdk-drag-dropped) {
  animation: return-to-position 0.5s cubic-bezier(0.2, 1, 0.1, 1);
}

// Main component styles
.ecrf-builder {
  // Toolbox items styles
  .toolbox-elements-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    min-height: 50px;
  }

  .element-item {
    @include card-style;
    cursor: grab;
    transition: $element-transition;
    box-shadow: $primary-shadow;
    user-select: none;

    &:hover {
      background-color: var(--surface-hover);
      transform: translateY(-2px);
      box-shadow: $hover-shadow;
    }

    &:active {
      cursor: grabbing;
    }

    i {
      font-size: 1.3rem;
      color: var(--primary-color);
    }

    .element-type-label {
      white-space: nowrap;
      text-overflow: ellipsis;
    }
  }

  .element-preview-container {
    width: 100px;
  }

  // Form canvas
  .form-canvas {
    min-height: 400px;
    padding: 1rem;
    background-color: var(--surface-ground);
    border-radius: 4px;
    border: 2px dashed var(--surface-border);
    transition: all 0.3s ease;

    // Empty state
    .empty-canvas-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      opacity: 0.6;

      i {
        font-size: 2rem;
        margin-bottom: 1rem;
        animation: point-left 1.5s infinite;
        color: var(--primary-color);
      }

      p {
        font-size: 1.2rem;
      }
    }
  }

  // Layout styles
  .form-elements-grid {
    display: grid;
    grid-gap: 1rem;
  }

  .form-elements-flow {
    .form-element-flow-item {
      flex: 0 0 auto;
      min-width: 300px;
      max-width: 100%;
      transition: all 0.3s ease;

      @media (min-width: 992px) {
        max-width: 49%;
      }
    }
  }

  // Form elements
  .form-element-wrapper {
    .drag-handle {
      cursor: move;
      display: inline-block;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      margin-right: 8px;
      color: var(--text-color-secondary);
      background-color: var(--surface-100);
      border-radius: 4px;
      transition: $element-transition;

      &:hover {
        background-color: var(--surface-200);
      }
    }

    .form-element {
      background-color: var(--surface-card);
      transition: $element-transition;
      position: relative;
      box-shadow: $primary-shadow;

      &:hover {
        box-shadow: $hover-shadow;
        transform: translateY(-2px);

        .element-actions {
          opacity: 1;
        }
      }

      .element-label {
        font-weight: 600;
        display: flex;
        align-items: center;

        i {
          color: var(--primary-color);
        }
      }

      .element-actions {
        opacity: 0.4;
        transition: opacity 0.2s ease;
      }

      .element-preview {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px dashed var(--surface-border);
      }
    }
  }

  .form-element-preview {
    z-index: 1000;
    background-color: var(--surface-card);
    box-shadow: $preview-shadow;
    border: 1px solid var(--primary-color);
    border-radius: 4px;
    padding: 10px;
    min-width: 200px;
    transform-origin: center center;
    animation: scale-in 0.15s ease;
    pointer-events: none;
  }

  .form-element-placeholder {
    background-color: rgba(var(--primary-color-rgb), 0.1);
    border: 2px dashed var(--primary-color);
    border-radius: 4px;
    min-height: 60px;
    transition: transform 250ms cubic-bezier(0, 0, 0.2, 1);
    animation: pulse 1.5s infinite;
  }

  // Layout options
  .layout-options {
    .grid-column-control {
      width: 100px;
    }
  }

  // Row and Column Styles
  .row-element {
    transition: all 0.3s ease;
    background-color: var(--surface-card);
    box-shadow: $primary-shadow;
    position: relative;

    &:hover {
      box-shadow: $hover-shadow;

      .row-actions {
        opacity: 1;
      }
    }

    .row-header {
      background-color: rgba(var(--primary-color-rgb), 0.05);

      .element-label {
        font-weight: 600;

        i {
          color: var(--primary-color);
        }
      }

      .row-actions {
        opacity: 0.6;
        transition: opacity 0.2s ease;
      }
    }

    .columns-container {
      display: flex;
      flex-wrap: wrap;
    }
  }

  .column-container {
    transition: all 0.3s ease;
    background-color: var(--surface-card);
    border: 1px dashed var(--surface-border);

    &:hover {
      border-color: var(--primary-color);

      .column-actions {
        opacity: 1;
      }
    }

    .column-header {
      background-color: rgba(var(--primary-color-rgb), 0.02);

      .element-label {
        font-weight: 500;
        font-size: 0.9rem;

        i {
          color: var(--primary-color);
        }
      }

      .column-actions {
        opacity: 0.6;
        transition: opacity 0.2s ease;
      }
    }

    .column-drop-zone {
      min-height: 100px;
      transition: all 0.3s ease;

      &.cdk-drop-list-dragging {
        border: 2px dashed var(--primary-color);
        background-color: rgba(var(--primary-color-rgb), 0.05);
      }
    }

    .empty-column-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      color: var(--text-color-secondary);
      border: 1px dashed var(--surface-border);

      i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      p {
        margin: 0;
      }
    }
  }

  .column-element-wrapper {
    .column-element {
      background-color: var(--surface-card);
      transition: $element-transition;
      position: relative;
      box-shadow: $primary-shadow;

      &:hover {
        box-shadow: $hover-shadow;
        transform: translateY(-1px);

        .element-actions {
          opacity: 1;
        }
      }
    }
  }

  // Layout configuration dialog
  .column-config {
    border: 1px solid var(--surface-border);

    h5 {
      margin: 0;
      font-size: 1rem;
    }
  }

  .columns-preview {
    .column-preview {
      text-align: center;
      font-size: 0.8rem;
      border: 1px solid var(--surface-border);
      transition: all 0.3s ease;
    }
  }

  // Layout instructions
  .layout-instructions {
    font-size: 0.9rem;

    ol {
      padding-left: 1.5rem;

      li {
        margin-bottom: 0.5rem;
      }
    }
  }
}

// Global drag state
:root.ecrf-dragging {
  cursor: grabbing !important;

  .form-canvas {
    border-color: var(--primary-color);
    background-color: rgba(var(--primary-color-rgb), 0.02);
  }

  .column-drop-zone {
    border: 2px dashed var(--surface-border);
    background-color: rgba(var(--primary-color-rgb), 0.02);
  }
}

.column-drop-zone {
  min-height: 100px;
  transition: all 0.3s ease;
  padding: 8px;
  border: 1px dashed transparent;

  // Enhanced drop zone indicators
  &.cdk-drop-list-dragging,
  &.cdk-drop-list-receiving {
    border: 2px dashed var(--primary-color);
    background-color: rgba(var(--primary-color-rgb), 0.05);
    animation: highlight-drop-zone 1.5s infinite;
  }

  // Make empty columns more visible as drop targets
  &:empty {
    min-height: 80px;
    border: 1px dashed var(--surface-border);

    &.cdk-drop-list-dragging {
      border: 2px dashed var(--primary-color);
    }
  }
}

.cdk-drop-list-dragging {
  background: lightgreen;
}

// Add active class for the current drop target
.column-drop-zone.active {
  background-color: rgba(var(--primary-color-rgb), 0.1);
  border-color: var(--primary-color);
}


// Responsive styling
@media screen and (max-width: 768px) {
  .ecrf-builder {
    .col-3, .col-9 {
      width: 100%;
    }

    .layout-options {
      flex-direction: column;
      align-items: flex-start;

      label, .p-dropdown, .grid-column-control {
        margin-bottom: 0.5rem;
      }
    }

    .columns-container {
      flex-direction: column;

      .column-container {
        width: 100% !important;
        margin-bottom: 1rem;
      }
    }
  }
}

// Make sure these styles are preserved
.column-drop-zone {
  min-height: 100px;
  transition: all 0.3s ease;
  padding: 8px;
  border: 1px dashed transparent;

  // Enhanced drop zone indicators
  &.cdk-drop-list-dragging,
  &.cdk-drop-list-receiving {
    border: 2px dashed var(--primary-color);
    background-color: rgba(var(--primary-color-rgb), 0.05);
  }
}

// Add this new style for the group
.cdk-drop-list-group {
  display: contents; // Ensures it doesn't affect layout
}
