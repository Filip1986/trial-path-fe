<div class="enhanced-participants-container">
  <!-- Contained loader (shown while initial data is loading) -->
  @if (loading && isInitialLoad) {
    <div class="fullscreen-loader">
      <div class="loader-content">
        <div class="loader"></div>
        <p class="loader-text">Loading participants...</p>
      </div>
    </div>
  }

  <!-- Main content (shown after data is loaded) -->
  @if (showContent && !loading) {
    <div [@pageEnter]="!dataFromCache">
      <!-- Header -->
      <div class="mb-6">
        <div class="flex justify-content-between align-items-center mb-4">
          <p-button
            (onClick)="navigateToEnroll()"
            icon="pi pi-plus"
            label="Enroll Participant"
            styleClass="p-button-primary"
            >
          </p-button>
          <div class="flex gap-2">
            <p-button
              (onClick)="importParticipants()"
              icon="pi pi-upload"
              label="Import"
              severity="secondary"
              styleClass="p-button-outlined"
              />
            <p-button
              (onClick)="exportData()"
              icon="pi pi-download"
              label="Export"
              severity="secondary"
              styleClass="p-button-outlined"
              />
          </div>
        </div>
      </div>
      <!-- Reusable Filters Component -->
      <app-table-filters
        (clearFilters)="onClearFilters()"
        (filterChange)="onFilterChange($event)"
        [filterFields]="filterFields"
        [filterValues]="filterValues"
        title="Participant Filters"
        />
      <!-- Participants Table -->
      <p-card header="Participants Overview">
        <!-- Table - Always shown since loading is handled by container -->
        <p-table
          #dt
          [globalFilterFields]="['firstName', 'lastName', 'participantId', 'email']"
          [paginator]="true"
          [rowsPerPageOptions]="[10, 25, 50]"
          [rows]="10"
          [showCurrentPageReport]="true"
          [value]="filteredParticipants"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords} participants"
          dataKey="id"
          responsiveLayout="scroll"
          scrollHeight="600px"
          styleClass="p-datatable-striped"
          >
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="participantId">
                ID <p-sortIcon field="participantId"></p-sortIcon>
              </th>
              <th pSortableColumn="firstName">Name <p-sortIcon field="firstName"></p-sortIcon></th>
              <th pSortableColumn="email">Email <p-sortIcon field="email"></p-sortIcon></th>
              <th pSortableColumn="dateOfBirth">Age <p-sortIcon field="dateOfBirth"></p-sortIcon></th>
              <th pSortableColumn="gender">Gender <p-sortIcon field="gender"></p-sortIcon></th>
              <th pSortableColumn="studyTitle">Study <p-sortIcon field="studyTitle"></p-sortIcon></th>
              <th pSortableColumn="status">Status <p-sortIcon field="status"></p-sortIcon></th>
              <th pSortableColumn="enrollmentDate">
                Enrollment Date <p-sortIcon field="enrollmentDate"></p-sortIcon>
              </th>
              <th>Actions</th>
            </tr>
          </ng-template>
          <ng-template let-participant pTemplate="body">
            <tr>
              <td>
                <span class="font-semibold">{{ participant.participantId }}</span>
              </td>
              <td>
                <div>
                  <span class="font-semibold"
                    >{{ participant.firstName }} {{ participant.lastName }}</span
                    >
                    <br />
                    <small class="text-600">{{ participant.middleName || '' }}</small>
                  </div>
                </td>
                <td>
                  <span>{{ participant.email }}</span>
                  <br />
                  <small class="text-600">{{ participant.phone }}</small>
                </td>
                <td>
                  <div class="max-w-20rem">
                    <span class="text-900">{{ participant.studyTitle }}</span>
                    <br />
                    <small class="text-600">{{ participant.randomizationGroup }}</small>
                  </div>
                </td>
                <td>
                  <p-tag
                    [severity]="getStatusSeverity(participant.status)"
                    [value]="participant.status | titlecase"
                  ></p-tag>
                </td>
                <td>
                  <span>{{ participant.enrollmentDate | date: 'shortDate' }}</span>
                  <br />
                  <small class="text-600"
                    >Last visit: {{ participant.lastVisit | date: 'shortDate' }}</small
                    >
                  </td>
                  <td>
                    <div class="text-sm">
                      <span
                        >{{ participant.gender | titlecase }}, {{ calculateAge(participant.dateOfBirth) }}
                        years</span
                        >
                        <br />
                        <small class="text-600">{{ participant.ethnicity }}</small>
                      </div>
                    </td>
                    <td>
                      <div class="text-sm">
                        <span>{{ participant.city }}, {{ participant.state }}</span>
                        <br />
                        <small class="text-600">Emergency: {{ participant.emergencyContactPhone }}</small>
                      </div>
                    </td>
                    <td>
                      <div class="flex gap-2">
                        <p-button
                          (onClick)="viewParticipant(participant)"
                          icon="pi pi-eye"
                          pTooltip="Review Eligibility"
                          styleClass="p-button-rounded p-button-text p-button-sm"
                        ></p-button>
                        <p-button
                          (onClick)="editParticipant(participant)"
                          icon="pi pi-pencil"
                          pTooltip="Edit"
                          styleClass="p-button-rounded p-button-text p-button-sm"
                        ></p-button>
                      </div>
                    </td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="9" class="text-center p-4">
                      <div class="flex flex-column align-items-center gap-3">
                        <i class="pi pi-users text-4xl text-color-secondary"></i>
                        <h3 class="text-xl font-semibold">No participants found</h3>
                        <p class="text-color-secondary">
                          Try adjusting your filters or enroll new participants.
                        </p>
                        <p-button
                          (onClick)="navigateToEnroll()"
                          icon="pi pi-plus"
                          label="Enroll First Participant"
                          styleClass="p-button-primary"
                          />
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </p-card>
          </div>
        }
      </div>
