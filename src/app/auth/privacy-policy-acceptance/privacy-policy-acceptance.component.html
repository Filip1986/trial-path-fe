<p-dialog
  [(visible)]="visible"
  [blockScroll]="true"
  [closable]="false"
  [closeOnEscape]="false"
  [draggable]="false"
  [modal]="true"
  [resizable]="false"
  [style]="{width: '800px', maxWidth: '95vw'}"
  header="Privacy Policy Acceptance Required"
  styleClass="privacy-policy-dialog"
  >
  @if (isLoading()) {
    <div class="flex justify-center my-6">
      <p-progressSpinner [style]="{width: '50px', height: '50px'}" strokeWidth="4" />
    </div>
  }

  @if (!isLoading() && errorMessage()) {
    <div class="p-4 bg-red-100 text-red-700 mb-4">
      <i class="pi pi-exclamation-circle mr-2"></i>
      {{ errorMessage() }}
    </div>
  }

  @if (!isLoading() && privacyPolicy) {
    <div class="privacy-policy-container">
      <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold">Version: {{ privacyPolicy.version }}</h2>
          <span class="text-sm">Effective: {{ privacyPolicy.effectiveDate | date:'medium' }}</span>
        </div>
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="pi pi-info-circle text-blue-500 mr-2"></i>
            </div>
            <div>
              <p class="text-sm text-blue-700">
                We've updated our Privacy Policy. Please review and accept to continue using our
                services. This ensures we're transparent about how we collect, use, and protect your
                data.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="privacy-policy-content border p-4 max-h-[400px] overflow-auto mb-4">
        <!-- Check if content is in HTML format -->
        @if (privacyPolicy.content.includes('<')) {
          <div [innerHTML]="privacyPolicy.content"></div>
        }
        <!-- If in markdown or plain text format, preserve line breaks -->
        @if (!privacyPolicy.content.includes('<')) {
          <div style="white-space: pre-line">
            {{ privacyPolicy.content }}
          </div>
        }
      </div>
      <div class="flex items-start mb-4 p-3 border">
        <p-checkbox [(ngModel)]="acceptanceChecked" [binary]="true" inputId="accept" />
        <label class="ml-2 text-sm" for="accept">
          I confirm that I have read and understood the privacy policy version {{
          privacyPolicy.version }} effective {{ privacyPolicy.effectiveDate | date:'shortDate' }} and
          consent to the collection, use, and processing of my data as described in this policy.
        </label>
      </div>
    </div>
  }

  <ng-template pTemplate="footer">
    <button
      (click)="acceptPolicy()"
      [disabled]="!acceptanceChecked || isAccepting() || isLoading()"
      [loading]="isAccepting()"
      aria-label="Accept and Continue"
      class="w-full"
      label="Accept and Continue"
      pButton
    ></button>
  </ng-template>
</p-dialog>
